Эмулятор ПЛК Эмикон
===================

Определения
-----------

Хост система - операционная система внутри которой запускается эмулятор.

Гостевая система - операционная система работающая под эмуляцией. В данном
эмуляторе гостевой системой является Linux.

ПО - программное обеспечение.

Введение
--------

Эмулятор ПЛК Эмикон основан на эмуляторе аппаратного обеспечение qemu:

	https://www.qemu.org

Эмулятор запускает ОС Linux с rootfs реального ПЛК. Ядро Linux эмулятора
отличается от ядра используемого в реальных ПЛК, но при этом поддерживает весь
необходимый функционал для работы в CODESYS.

Все аппаратно зависимые программные модули CODESYS либо эмитируют аппаратное
поведение, либо шунтируют код работы с аппаратурой и выдают положительные
ответы. Функции шунтирующие обращение к аппаратуре планируется в дальнейшем
доработать до эмуляции аппаратуры.

Связь эмулятора с сетью хост системы осуществляется через виртуальный сетевой
интерфейс TAP. TAP интерфейс в ОС Windows устанавливается отдельным драйвером и
идет в комплекте поставки данного эмулятора.

Драйвер виртуального сетевого интерфейса взят из пакета OpenVPN:
	https://openvpn.net/

Гостевая система Linux эмулятора поддерживает ssh подключение терминалов и
SFTP подключения файловых менеджеров.

Учетная запись по умолчанию root без пароля.


Установка
---------

Установка эмулятора осуществляется запуском скрипта setup.bat. После установки
эмулятора в хост системе появится (если не было) виртуальный сетевой интерфейс
TAP-Windows Adapter V9. На рабочем столе появится ярлык запуска эмулятора.

Гостевая система эмулятора по умолчанию настроена на статический IP адрес:
  
    192.168.67.2 с маской 255.255.255.0

Поэтому для сетевой связи хост системы с гостевой перед запуском следует
однократно настроить виртуальный сетевой интерфейс хоста  TAP-Windows Adapter V9
на статический IP диапазона 192.168.67.0 (например 192.168.67.1) с маской
255.255.255.0.

После первой установки эмулятора в хост системе, для правильного
функционирования TAP интерфейса требуется перезагрузка хост системы. Удаление
эмулятора не удаляет драйвера TAP интерфейса, поэтому последующая установка
не потребует перезапуска хост системы.

После перезагрузки и настройки статического IP адреса TAP интерфейса эмулятор
готов к использованию.

Удаление
--------

Удаление осуществляется запуском скрипта uninstall.bat.


Описание алгоритма установки и удаления
---------------------------------------

Данный раздел носит информативный характер описывающий действия установщика
эмулятора.

При запуске setup.bat установщик проверяет наличие в системе интерфейса
TAP-Windows Adapter V9 и при его отсутствии автоматически установит драйвер
этого интерфейса. Для этого действия установщик в процессе установки драйвера
запросит права Администратора.

После нахождения или установки TAP интерфейса, установщик скопирует все
необходимые файлы по пути C:\Users\Имя пользователя\AppData\Local (скрытая).

Затем установщик создает скрипт запуска эмулятора с прописыванием в него всех
необходимых путей и параметров и выносит на рабочий стол ярлык на этот скрипт.

Деинсталляция удаляет все файлы эмулятора, но не деинсталлирует TAP интерфейс.
Это связанно с тем, что TAP интерфейс может быть установленным не эмулятором, а
сторонним ПО, например OpenVPN. В этом случае его удаление приведет
к ошибкам стороннего ПО.


Заметки
-------

1)  Тесты установки эмулятора проводились на операционных системах Windows:
    10_64_enterprise, 10_86, 10_64, 8.1_86, 8.1_64, 7_86, 7_64

2)  TAP интерфейс - это универсальный виртуальный сетевой интрефейс, который
    может быть использован другим ПО. Этот интерфейс не допускает одновременного
    подключения нескольких ПО. Поэтому если в системе уже используется TAP
    интерфейс сторонним ПО, то следует создать второй (или очередной)
    виртуальный TAP интерфейс выполнением утилиты с параметрами:

    C:\Program Files\TAP-Windows\bin\tapinstall.exe install "C:\Program Files\TAP-Windows\driver\OemVista.inf" tap0901

    После установки дополнительного TAP интерфеса в скрипте запуска эмулятора
    поправить параметр ifname в соответствии с именем нового интерфейса.
    Например:
    
      -net "tap,ifname=Ethernet 2"

    где 'Ethernet 2' имя нового интерфейса.


3)  Для подключения и управления гостевой системой эмулятора рекомендуется
    использовать отличный от встроенного терминала Windows. Например putty:

        https://www.putty.org/

    Встроенный терминал Windows имеет множество неудобных ограничений.
    При использовании putty не следует закрывать окно запуска эмулятора. Это
    приведет к выключению эмулятора.

4)  При запуске эмулятора в окне терминала Windows можно наблюдать непонятные
    символы в начале строк наподобии таких:

        [[0;32m  OK  [0m] Started Network Service.
        7[r[999;999H[6n root@emu_cpu47_var33:~#

    Это коды определяющие цвет (коллоризация) вывода лога ОС Linux которые
    стандартный терминал Windows не определяет. На работу эмулятора эти коды
    не влияют.

5) Выключение эмулятора строго рекомендуется командой в гостевой системе: 
        poweroff





